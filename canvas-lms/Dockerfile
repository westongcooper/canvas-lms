FROM instructure/canvas-lms:master

ENV RAILS_ENV "production"
ENV COMPILE_ASSETS_NPM_INSTALL 0
ENV APP_DIR="/usr/src/app"

WORKDIR ${APP_DIR}

RUN gem install bundler --version 1.17.3
RUN yarn install


RUN mkdir -p log tmp/pids public/assets app/stylesheets/brandable_css_brands && \
    touch app/stylesheets/_brandable_variables_defaults_autogenerated.scss && \
    touch Gemfile.lock && touch log/production.log

RUN echo "gem 'tzinfo-data'" >> Gemfile
RUN bundle install
RUN COMPILE_ASSETS_STYLEGUIDE="0" COMPILE_ASSETS_API_DOCS="0" SKIP_SOURCEMAPS="1" CANVAS_BUILD_CONCURRENCY=1 bundle exec rake canvas:compile_assets

ADD database.yml ${APP_DIR}/config/database.yml
ADD security.yml ${APP_DIR}/config/security.yml
ADD dynamic_settings.yml ${APP_DIR}/config/dynamic_settings.yml
ADD domain.yml ${APP_DIR}/config/domain.yml
ADD redis.yml ${APP_DIR}/config/redis.yml
ADD cache_store.yml ${APP_DIR}/config/cache_store.yml
ADD public_file_server.rb ${APP_DIR}/config/initializers/public_file_server.rb

ADD start.sh start.sh
CMD ["/usr/src/app/start.sh"]